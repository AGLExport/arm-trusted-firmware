/*
 * Copyright (c) 2015-2017, Renesas Electronics Corporation
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 *   - Redistributions of source code must retain the above copyright notice,
 *     this list of conditions and the following disclaimer.
 *
 *   - Redistributions in binary form must reproduce the above copyright
 *     notice, this list of conditions and the following disclaimer in the
 *     documentation and/or other materials provided with the distribution.
 *
 *   - Neither the name of Renesas nor the names of its contributors may be
 *     used to endorse or promote products derived from this software without
 *     specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */

#include <stdint.h>
#include <debug.h>
#include "../qos_common.h"
#include "../qos_reg.h"
#include "qos_init_h3_v20.h"


#define	RCAR_QOS_VERSION		"rev.0.17"


#if RCAR_QOS_TYPE  == RCAR_QOS_TYPE_DEFAULT
static const mstat_slot_t mstat_fix[] = {
	{0x0000U, 0x0000000000000000U},
	{0x0008U, 0x0000000000000000U},
	{0x0010U, 0x0000000000000000U},
	{0x0018U, 0x0000000000000000U},
	{0x0020U, 0x0000000000000000U},
	{0x0028U, 0x0000000000000000U},
	{0x0030U, 0x001004030000FFFFU},
	{0x0038U, 0x001008060000FFFFU},
	{0x0040U, 0x001424120000FFFFU},
	{0x0048U, 0x0000000000000000U},
	{0x0050U, 0x001404010000FFFFU},
	{0x0058U, 0x0014100F0000FFFFU},
	{0x0060U, 0x00140C0C0000FFFFU},
	{0x0068U, 0x0000000000000000U},
	{0x0070U, 0x001404010000FFFFU},
	{0x0078U, 0x001008060000FFFFU},
	{0x0080U, 0x0000000000000000U},
	{0x0088U, 0x001424120000FFFFU},
	{0x0090U, 0x00140C0C0000FFFFU},
	{0x0098U, 0x0000000000000000U},
	{0x00A0U, 0x000C04020000FFFFU},
	{0x00A8U, 0x000C04010000FFFFU},
	{0x00B0U, 0x000C04010000FFFFU},
	{0x00B8U, 0x0000000000000000U},
	{0x00C0U, 0x000C04020000FFFFU},
	{0x00C8U, 0x000C04010000FFFFU},
	{0x00D0U, 0x000C04010000FFFFU},
	{0x00D8U, 0x001020080000FFFFU},
	{0x00E0U, 0x001008080000FFFFU},
	{0x00E8U, 0x0000000000000000U},
	{0x00F0U, 0x001020080000FFFFU},
	{0x00F8U, 0x000C08060000FFFFU},
	{0x0100U, 0x0000000000000000U},
	{0x0108U, 0x0000000000000000U},
	{0x0110U, 0x001008080000FFFFU},
	{0x0118U, 0x000C100F0000FFFFU},
	{0x0120U, 0x000C100F0000FFFFU},
	{0x0128U, 0x0000000000000000U},
	{0x0130U, 0x0000000000000000U},
	{0x0138U, 0x00100C0A0000FFFFU},
	{0x0140U, 0x00100C0A0000FFFFU},
	{0x0148U, 0x0000000000000000U},
	{0x0150U, 0x00100C0C0000FFFFU},
	{0x0158U, 0x00100C0C0000FFFFU},
	{0x0160U, 0x00100C0A0000FFFFU},
	{0x0168U, 0x00100C0A0000FFFFU},
	{0x0170U, 0x0000000000000000U},
	{0x0178U, 0x001008050000FFFFU},
	{0x0180U, 0x001008050000FFFFU},
	{0x0188U, 0x0000000000000000U},
	{0x0190U, 0x00102C2A0000FFFFU},
	{0x0198U, 0x00102C2A0000FFFFU},
	{0x01A0U, 0x00100C0A0000FFFFU},
	{0x01A8U, 0x00100C0A0000FFFFU},
	{0x01B0U, 0x0000000000000000U},
	{0x01B8U, 0x0000000000000000U},
	{0x01C0U, 0x000C04010000FFFFU},
	{0x01C8U, 0x000C04010000FFFFU},
	{0x01D0U, 0x000C04010000FFFFU},
	{0x01D8U, 0x000C04010000FFFFU},
	{0x01E0U, 0x0000000000000000U},
	{0x01E8U, 0x000C04010000FFFFU},
	{0x01F0U, 0x000C04010000FFFFU},
	{0x01F8U, 0x0000000000000000U},
	{0x0200U, 0x0000000000000000U},
	{0x0208U, 0x000C04010000FFFFU},
	{0x0210U, 0x000C04010000FFFFU},
	{0x0218U, 0x0000000000000000U},
	{0x0220U, 0x0000000000000000U},
	{0x0228U, 0x0000000000000000U},
	{0x0230U, 0x0000000000000000U},
	{0x0238U, 0x0000000000000000U},
	{0x0240U, 0x0000000000000000U},
	{0x0248U, 0x0000000000000000U},
	{0x0250U, 0x0000000000000000U},
	{0x0258U, 0x0000000000000000U},
	{0x0260U, 0x000C08020000FFFFU},
	{0x0268U, 0x001408010000FFFFU},
	{0x0270U, 0x001404010000FFFFU},
	{0x0278U, 0x000C04010000FFFFU},
	{0x0280U, 0x0000000000000000U},
	{0x0288U, 0x0000000000000000U},
	{0x0290U, 0x001408010000FFFFU},
	{0x0298U, 0x001404010000FFFFU},
	{0x02A0U, 0x000C04010000FFFFU},
	{0x02A8U, 0x000C04010000FFFFU},
	{0x02B0U, 0x001404010000FFFFU},
	{0x02B8U, 0x000C04010000FFFFU},
	{0x02C0U, 0x0000000000000000U},
	{0x02C8U, 0x0000000000000000U},
	{0x02D0U, 0x000C04010000FFFFU},
	{0x02D8U, 0x000C04010000FFFFU},
	{0x02E0U, 0x001404010000FFFFU},
	{0x02E8U, 0x000C04010000FFFFU},
	{0x02F0U, 0x0000000000000000U},
	{0x02F8U, 0x0000000000000000U},
	{0x0300U, 0x0000000000000000U},
	{0x0308U, 0x0000000000000000U},
	{0x0310U, 0x0000000000000000U},
	{0x0318U, 0x0000000000000000U},
	{0x0320U, 0x0000000000000000U},
	{0x0328U, 0x0000000000000000U},
	{0x0330U, 0x0000000000000000U},
	{0x0338U, 0x0000000000000000U},
	{0x0340U, 0x0000000000000000U},
	{0x0348U, 0x0000000000000000U},
	{0x0350U, 0x0000000000000000U},
	{0x0358U, 0x0000000000000000U},
	{0x0360U, 0x0000000000000000U},
	{0x0368U, 0x0000000000000000U},
};

static const mstat_slot_t mstat_be[] = {
	{0x0000U, 0x001200600C8FFC01U},
	{0x0008U, 0x001200600C8FFC01U},
	{0x0010U, 0x001200600C8FFC01U},
	{0x0018U, 0x001200600C8FFC01U},
	{0x0020U, 0x0000000000000000U},
	{0x0028U, 0x001200100C80FC01U},
	{0x0030U, 0x0000000000000000U},
	{0x0038U, 0x0000000000000000U},
	{0x0040U, 0x0000000000000000U},
	{0x0048U, 0x0000000000000000U},
	{0x0050U, 0x0000000000000000U},
	{0x0058U, 0x0000000000000000U},
	{0x0060U, 0x0000000000000000U},
	{0x0068U, 0x0000000000000000U},
	{0x0070U, 0x0000000000000000U},
	{0x0078U, 0x0000000000000000U},
	{0x0080U, 0x0000000000000000U},
	{0x0088U, 0x0000000000000000U},
	{0x0090U, 0x0000000000000000U},
	{0x0098U, 0x0000000000000000U},
	{0x00A0U, 0x0000000000000000U},
	{0x00A8U, 0x0000000000000000U},
	{0x00B0U, 0x0000000000000000U},
	{0x00B8U, 0x0000000000000000U},
	{0x00C0U, 0x0000000000000000U},
	{0x00C8U, 0x0000000000000000U},
	{0x00D0U, 0x0000000000000000U},
	{0x00D8U, 0x0000000000000000U},
	{0x00E0U, 0x0000000000000000U},
	{0x00E8U, 0x0000000000000000U},
	{0x00F0U, 0x0000000000000000U},
	{0x00F8U, 0x0000000000000000U},
	{0x0100U, 0x0000000000000000U},
	{0x0108U, 0x0000000000000000U},
	{0x0110U, 0x0000000000000000U},
	{0x0118U, 0x0000000000000000U},
	{0x0120U, 0x0000000000000000U},
	{0x0128U, 0x0000000000000000U},
	{0x0130U, 0x0000000000000000U},
	{0x0138U, 0x0000000000000000U},
	{0x0140U, 0x0000000000000000U},
	{0x0148U, 0x0000000000000000U},
	{0x0150U, 0x0000000000000000U},
	{0x0158U, 0x0000000000000000U},
	{0x0160U, 0x0000000000000000U},
	{0x0168U, 0x0000000000000000U},
	{0x0170U, 0x0000000000000000U},
	{0x0178U, 0x0000000000000000U},
	{0x0180U, 0x0000000000000000U},
	{0x0188U, 0x0000000000000000U},
	{0x0190U, 0x0000000000000000U},
	{0x0198U, 0x0000000000000000U},
	{0x01A0U, 0x0000000000000000U},
	{0x01A8U, 0x0000000000000000U},
	{0x01B0U, 0x0000000000000000U},
	{0x01B8U, 0x0000000000000000U},
	{0x01C0U, 0x002100600C8FFC01U},
	{0x01C8U, 0x002100600C8FFC01U},
	{0x01D0U, 0x002100600C8FFC01U},
	{0x01D8U, 0x002100600C8FFC01U},
	{0x01E0U, 0x0000000000000000U},
	{0x01E8U, 0x0000000000000000U},
	{0x01F0U, 0x002100100C8FFC01U},
	{0x01F8U, 0x0000000000000000U},
	{0x0200U, 0x0000000000000000U},
	{0x0208U, 0x0000000000000000U},
	{0x0210U, 0x002100100C8FFC01U},
	{0x0218U, 0x001100100C8FFC01U},
	{0x0220U, 0x001100100C8FFC01U},
	{0x0228U, 0x0000000000000000U},
	{0x0230U, 0x001100100C8FFC01U},
	{0x0238U, 0x001100100C8FFC01U},
	{0x0240U, 0x001200100C8FFC01U},
	{0x0248U, 0x001100100C8FFC01U},
	{0x0250U, 0x001200100C8FFC01U},
	{0x0258U, 0x001100100C8FFC01U},
	{0x0260U, 0x0000000000000000U},
	{0x0268U, 0x0000000000000000U},
	{0x0270U, 0x0000000000000000U},
	{0x0278U, 0x0000000000000000U},
	{0x0280U, 0x0000000000000000U},
	{0x0288U, 0x0000000000000000U},
	{0x0290U, 0x0000000000000000U},
	{0x0298U, 0x0000000000000000U},
	{0x02A0U, 0x0000000000000000U},
	{0x02A8U, 0x0000000000000000U},
	{0x02B0U, 0x0000000000000000U},
	{0x02B8U, 0x0000000000000000U},
	{0x02C0U, 0x0000000000000000U},
	{0x02C8U, 0x0000000000000000U},
	{0x02D0U, 0x0000000000000000U},
	{0x02D8U, 0x0000000000000000U},
	{0x02E0U, 0x0000000000000000U},
	{0x02E8U, 0x0000000000000000U},
	{0x02F0U, 0x001100600C8FFC01U},
	{0x02F8U, 0x001100600C8FFC01U},
	{0x0300U, 0x0000000000000000U},
	{0x0308U, 0x001100600C8FFC01U},
	{0x0310U, 0x001100600C8FFC01U},
	{0x0318U, 0x001200100C803401U},
	{0x0320U, 0x001100600C8FFC01U},
	{0x0328U, 0x001100600C8FFC01U},
	{0x0330U, 0x001100600C8FFC01U},
	{0x0338U, 0x001100600C8FFC01U},
	{0x0340U, 0x0000000000000000U},
	{0x0348U, 0x0000000000000000U},
	{0x0350U, 0x0000000000000000U},
	{0x0358U, 0x0000000000000000U},
	{0x0360U, 0x0000000000000000U},
	{0x0368U, 0x001200100C80FC01U},
};
#endif

static void dbsc_setting(void)
{
	uint32_t md=0;

	/* BUFCAM settings */
	io_write_32(DBSC_DBCAM0CNF1, 0x00043218U);	//dbcam0cnf1
	io_write_32(DBSC_DBCAM0CNF2, 0x000000F4U);	//dbcam0cnf2
	io_write_32(DBSC_DBCAM0CNF3, 0x00000000U);	//dbcam0cnf3
	io_write_32(DBSC_DBSCHCNT0,  0x000F0037U);	//dbschcnt0
	io_write_32(DBSC_DBSCHSZ0,   0x00000001U);	//dbschsz0
	io_write_32(DBSC_DBSCHRW0,   0x22421111U);	//dbschrw0

	md = (*((volatile uint32_t*)RST_MODEMR) & 0x000A0000) >> 17;

	switch (md) {
	case 0x0:
		/* DDR3200 */
		io_write_32(DBSC_SCFCTST2, 0x012F1123U);
		break;
	case 0x1:	//MD19=0,MD17=1 : LPDDR4-3000, 4GByte(1GByte x4)
		/* DDR2800 */
		io_write_32(DBSC_SCFCTST2, 0x012F1123U);
		break;
	case 0x4:	//MD19=1,MD17=0 : LPDDR4-2400, 4GByte(1GByte x4)
		/* DDR2400 */
		io_write_32(DBSC_SCFCTST2, 0x012F1123U);
		break;
	default:	//MD19=1,MD17=1 : LPDDR4-1600, 4GByte(1GByte x4)
		/* DDR1600 */
		io_write_32(DBSC_SCFCTST2, 0x012F1123U);
		break;
	}

	/* QoS Settings */
	io_write_32(DBSC_DBSCHQOS00,  0x00000F00U);
	io_write_32(DBSC_DBSCHQOS01,  0x00000B00U);
	io_write_32(DBSC_DBSCHQOS02,  0x00000000U);
	io_write_32(DBSC_DBSCHQOS03,  0x00000000U);
	io_write_32(DBSC_DBSCHQOS40,  0x00000300U);
	io_write_32(DBSC_DBSCHQOS41,  0x000002F0U);
	io_write_32(DBSC_DBSCHQOS42,  0x00000200U);
	io_write_32(DBSC_DBSCHQOS43,  0x00000100U);
	io_write_32(DBSC_DBSCHQOS90,  0x00000300U);
	io_write_32(DBSC_DBSCHQOS91,  0x000002F0U);
	io_write_32(DBSC_DBSCHQOS92,  0x00000200U);
	io_write_32(DBSC_DBSCHQOS93,  0x00000100U);
	io_write_32(DBSC_DBSCHQOS120, 0x00000040U);
	io_write_32(DBSC_DBSCHQOS121, 0x00000030U);
	io_write_32(DBSC_DBSCHQOS122, 0x00000020U);
	io_write_32(DBSC_DBSCHQOS123, 0x00000010U);
	io_write_32(DBSC_DBSCHQOS130, 0x00000100U);
	io_write_32(DBSC_DBSCHQOS131, 0x000000F0U);
	io_write_32(DBSC_DBSCHQOS132, 0x000000A0U);
	io_write_32(DBSC_DBSCHQOS133, 0x00000040U);
	io_write_32(DBSC_DBSCHQOS140, 0x000000C0U);
	io_write_32(DBSC_DBSCHQOS141, 0x000000B0U);
	io_write_32(DBSC_DBSCHQOS142, 0x00000080U);
	io_write_32(DBSC_DBSCHQOS143, 0x00000040U);
	io_write_32(DBSC_DBSCHQOS150, 0x00000040U);
	io_write_32(DBSC_DBSCHQOS151, 0x00000030U);
	io_write_32(DBSC_DBSCHQOS152, 0x00000020U);
	io_write_32(DBSC_DBSCHQOS153, 0x00000010U);
}

void qos_init_h3_v20(void)
{
	dbsc_setting();

	/* DRAM Split Address mapping */
#if (RCAR_DRAM_SPLIT == RCAR_DRAM_SPLIT_4CH) || \
    (RCAR_DRAM_SPLIT == RCAR_DRAM_SPLIT_AUTO)
	NOTICE("BL2: DRAM Split is 4ch\n");
	io_write_32(AXI_ADSPLCR0, ADSPLCR0_ADRMODE_DEFAULT
				  | ADSPLCR0_SPLITSEL(0xFFU)
				  | ADSPLCR0_AREA(0x1BU)
				  | ADSPLCR0_SWP);
	io_write_32(AXI_ADSPLCR1, 0x00000000U);
	io_write_32(AXI_ADSPLCR2, 0x00001054U);
	io_write_32(AXI_ADSPLCR3, 0x00000000U);
#elif RCAR_DRAM_SPLIT == RCAR_DRAM_SPLIT_2CH
	NOTICE("BL2: DRAM Split is 2ch\n");
	io_write_32(AXI_ADSPLCR0, 0x00000000U);
	io_write_32(AXI_ADSPLCR1, ADSPLCR0_ADRMODE_DEFAULT
				  | ADSPLCR0_SPLITSEL(0xFFU)
				  | ADSPLCR0_AREA(0x1BU)
				  | ADSPLCR0_SWP);
	io_write_32(AXI_ADSPLCR2, 0x00001004U);
	io_write_32(AXI_ADSPLCR3, 0x00000000U);
#else
	NOTICE("BL2: DRAM Split is OFF\n");
#endif

#if !(RCAR_QOS_TYPE == RCAR_QOS_NONE)
#if RCAR_QOS_TYPE  == RCAR_QOS_TYPE_DEFAULT
	NOTICE("BL2: QoS is default setting(%s)\n", RCAR_QOS_VERSION);
#endif

	io_write_32(QOSCTRL_RAS,   0x00000044U);
	io_write_64(QOSCTRL_DANN,  0x0404010002020201U);
	io_write_32(QOSCTRL_DANT,  0x0020100AU);
	io_write_32(QOSCTRL_INSFC, 0xC7840001U);
	io_write_32(QOSCTRL_RACNT0, 0x00010003U);

	/* GPU Boost Mode */
	io_write_32(QOSCTRL_STATGEN0, 0x00000001U);

	io_write_32(QOSCTRL_SL_INIT, SL_INIT_REFFSSLOT | SL_INIT_SLOTSSLOT | SL_INIT_SSLOTCLK);
	io_write_32(QOSCTRL_REF_ARS, 0x00330000U);

	{
	uint32_t i;

	for (i = 0U; i < ARRAY_SIZE(mstat_fix); i++) {
		io_write_64(QOSBW_FIX_QOS_BANK0 + mstat_fix[i].addr,
				mstat_fix[i].value);
		io_write_64(QOSBW_FIX_QOS_BANK1 + mstat_fix[i].addr,
				mstat_fix[i].value);
	}
	for (i = 0U; i < ARRAY_SIZE(mstat_be); i++) {
		io_write_64(QOSBW_BE_QOS_BANK0 + mstat_be[i].addr,
				mstat_be[i].value);
		io_write_64(QOSBW_BE_QOS_BANK1 + mstat_be[i].addr,
				mstat_be[i].value);
	}
	}

	/* 3DG bus Leaf setting */
	io_write_32(GPU_ACT0, 0x00000000U);
	io_write_32(GPU_ACT1, 0x00000000U);
	io_write_32(GPU_ACT2, 0x00000000U);
	io_write_32(GPU_ACT3, 0x00000000U);
	io_write_32(GPU_ACT4, 0x00000000U);
	io_write_32(GPU_ACT5, 0x00000000U);
	io_write_32(GPU_ACT6, 0x00000000U);
	io_write_32(GPU_ACT7, 0x00000000U);

	/* RT bus Leaf setting */
	io_write_32(RT_ACT0, 0x00000000U);
	io_write_32(RT_ACT1, 0x00000000U);

	/* CCI bus Leaf setting */
	io_write_32(CPU_ACT0, 0x00000003U);
	io_write_32(CPU_ACT1, 0x00000003U);
	io_write_32(CPU_ACT2, 0x00000003U);
	io_write_32(CPU_ACT3, 0x00000003U);

	io_write_32(QOSCTRL_RAEN,  0x00000001U);

	io_write_32(QOSCTRL_STATQC, 0x00000001U);
#else
	NOTICE("BL2: QoS is None\n");

	io_write_32(QOSCTRL_RAEN,  0x00000001U);
#endif /* !(RCAR_QOS_TYPE == RCAR_QOS_NONE) */
}
